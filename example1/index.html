<html>
	<head>
		<title>Hello outliner</title>
		<meta name="copyright" content="Copyright 2013, Small Picture, Inc.">
		<script src="http://rawgithub.com/scripting/concord/master/libraries/jquery-1.9.1.min.js"></script>
		<link href="http://rawgithub.com/scripting/concord/master/libraries/bootstrap.css" rel="stylesheet">
		<script src="http://rawgithub.com/scripting/concord/master/libraries/bootstrap.min.js"></script>
		<link rel="stylesheet" href="http://rawgithub.com/scripting/concord/master/concord.css"/>
		<script src="http://rawgithub.com/scripting/concord/master/concord.js"></script>
		<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
		
		<script>
			var appConsts = {
				"productname": "Hello Outliner",
				"productnameForDisplay": "Hello",
				"domain": "hello.blorkmark.com", 
				"version": "0.40"
				}
			var appPrefs = {
				"outlineFont": "Georgia", "outlineFontSize": 18, "outlineLineHeight": 27,
				"authorName": "", "authorEmail": ""
				};
			var whenLastKeystroke = new Date (), whenLastAutoSave = new Date ();  
			var flReadOnly = false, flRenderMode = false,  flNewOutline = false;
			
			var appTypeIcons = {
				"blogpost": "file-text-alt",
				"essay": "file-text-alt", //2/11/13 by DW
				"code": "laptop",
				"directory": "folder-open-alt",
				"discusstree": "comments",
				"home": "home",
				"html": "file-text-alt",
				"icon-comment": "comment-alt", //2/16/13 by DW
				"icon-star": "star-empty", //2/16/13 by DW
				"icon-time": "time", //2/16/13 by DW
				"icon-user": "user", //2/16/13 by DW
				"include": "share-alt", //5/19/13 by DW
				"index": "file-text-alt",
				"link": "bookmark-empty",
				"outline": "file-text-alt",
				"photo": "camera",
				"presentation": "file-text-alt",
				"redirect": "refresh",
				"river": "file-text-alt",
				"rss": "rss",
				"tabs": "file-text-alt",
				"thread": "comments",
				"thumblist": "th",
				"profile": "user", //5/14/13 by DW
				"calendar": "calendar", //6/3/13 by DW
				"markdown": "file-text-alt", //6/3/13 by DW
				"tweet": "twitter", //6/10/13 by DW
				"metaWeblogPost": "file-text-alt"
				}
			var initialOpmltext = 
				"<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><opml version=\"2.0\"><head><title>Untitled</title></head><body><outline text=\"\"/></body></opml>";
			var defaultUtilsOutliner = "#outliner"; 
			
			//op glue routines
				function opUndo () {
					return ($(defaultUtilsOutliner).concord ().op.undo ())
					}
				function opCut () {
					return ($(defaultUtilsOutliner).concord ().op.cut ())
					}
				function opCopy () {
					return ($(defaultUtilsOutliner).concord ().op.copy ())
					}
				function opPaste () {
					return ($(defaultUtilsOutliner).concord ().op.paste ())
					}
				function opReorg (dir, count) {
					return ($(defaultUtilsOutliner).concord().op.reorg (dir, count));
					}
				function opSetFont (font, fontsize, lineheight) {
					$(defaultUtilsOutliner).concord().prefs({"outlineFont": font, "outlineFontSize": fontsize, "outlineLineHeight": lineheight});
					}
				function opPromote () {
					$(defaultUtilsOutliner).concord().op.promote();
					}
				function opDemote () {
					$(defaultUtilsOutliner).concord().op.demote();
					}
				function opBold () {
					return ($(defaultUtilsOutliner).concord().op.bold ());
					}
				function opItalic () {
					return ($(defaultUtilsOutliner).concord().op.italic ());
					}
				function opLink (url) {
					return ($(defaultUtilsOutliner).concord().op.link (url));
					}
				function opSetTextMode (fltextmode) {
					$(defaultUtilsOutliner).concord ().op.setTextMode (fltextmode);
					}
				function opInTextMode () {
					return ($(defaultUtilsOutliner).concord ().op.inTextMode ());
					}
				
				function opGetAtts () {
					return $(defaultUtilsOutliner).concord().op.attributes.getAll();
					}
				function opGetOneAtt (name) {
					return $(defaultUtilsOutliner).concord().op.attributes.getOne (name);
					}
				function opHasAtt (name) {
					return (opGetOneAtt (name) != undefined);
					}
				function opSetOneAtt (name, value) {
					return $(defaultUtilsOutliner).concord().op.attributes.setOne (name, value);
					}
				function opSetAtts (atts) {
					return $(defaultUtilsOutliner).concord().op.attributes.setGroup(atts);
					}
				function opAddAtts (atts) { //2/1/13 by DW
					return $(defaultUtilsOutliner).concord().op.attributes.addGroup(atts);
					}
				
				function opSetStyle (css) {
					return $(defaultUtilsOutliner).concord ().op.setStyle (css);
					}
				
				function opGetLineText () {
					return ($(defaultUtilsOutliner).concord().op.getLineText());
					}
				function opExpand () {
					return ($(defaultUtilsOutliner).concord().op.expand());
					}
				function opExpandAllLevels () {
					return ($(defaultUtilsOutliner).concord().op.expandAllLevels());
					}
				function opExpandEverything () {
					return ($(defaultUtilsOutliner).concord().op.fullExpand());
					}
				function opCollapse () {
					return ($(defaultUtilsOutliner).concord().op.collapse());
					}
				function opIsComment () {
					return ($(defaultUtilsOutliner).concord ().script.isComment ());
					}
				function opMakeComment () {
					return ($(defaultUtilsOutliner).concord ().script.makeComment ());
					}
				function opUnComment () {
					return ($(defaultUtilsOutliner).concord ().script.unComment ());
					}
				function opToggleComment () {
					if (opIsComment ()) {
						opUnComment ();
						}
					else {
						opMakeComment ();
						}
					}
				function opCollapseEverything () {
					return ($(defaultUtilsOutliner).concord().op.fullCollapse());
					}
				function opInsert (s, dir) {
					return ($(defaultUtilsOutliner).concord().op.insert(s, dir));
					}
				function opInsertImage (url) {
					return ($(defaultUtilsOutliner).concord ().op.insertImage (url));
					}
				function opSetLineText (s) {
					return ($(defaultUtilsOutliner).concord().op.setLineText(s));
					}
				function opDeleteSubs () {
					return ($(defaultUtilsOutliner).concord().op.deleteSubs());
					}
				function opCountSubs () {
					return ($(defaultUtilsOutliner).concord().op.countSubs());
					}
				function opHasSubs () { //3/8/13 by DW
					return (opCountSubs () > 0);
					}
				function opSubsExpanded () {
					return ($(defaultUtilsOutliner).concord().op.subsExpanded());
					}
				function opGo (dir, ct) {
					return ($(defaultUtilsOutliner).concord().op.go(dir, ct));
					}
				function opFirstSummit () {
					opGo (left, 32767);
					opGo (up, 32767);
					}
				function opXmlToOutline (xmltext) {
					return ($(defaultUtilsOutliner).concord ().op.xmlToOutline (xmltext));
					}
				function opInsertXml (xmltext, dir) { //2/14/13 by DW
					return ($(defaultUtilsOutliner).concord ().op.insertXml (xmltext, dir));
					}
				function opOutlineToXml (ownerName, ownerEmail, ownerId) {
					return ($(defaultUtilsOutliner).concord ().op.outlineToXml (ownerName, ownerEmail, ownerId));
					}
				function opCursorToXml () {
					return ($(defaultUtilsOutliner).concord ().op.cursorToXml ());
					}
				function opSetTitle (title) {
					return ($(defaultUtilsOutliner).concord ().op.setTitle (title));
					}
				function opGetTitle () {
					return ($(defaultUtilsOutliner).concord ().op.getTitle ());
					}
				function opHasChanged () {
					return ($(defaultUtilsOutliner).concord ().op.changed ());
					}
				function opClearChanged () {
					return ($(defaultUtilsOutliner).concord ().op.clearChanged ());
					}
				function opMarkChanged () { //3/24/13 by DW
					return ($(defaultUtilsOutliner).concord ().op.markChanged ());
					}
				function opRedraw () { //3/9/13 by DW
					return ($(defaultUtilsOutliner).concord ().op.redraw ());
					}
			
			
			function initLocalStorage () {
				if (localStorage.ctOpmlSaves == undefined) {
					localStorage.ctOpmlSaves = 0;
					}
				if (localStorage.savedOpmltext == undefined) {
					localStorage.savedOpmltext = initialOpmltext;
					flNewOutline = true;
					}
				if (localStorage.whenLastSave == undefined) {
					localStorage.whenLastSave = new Date ().toString ();
					}
				if (localStorage.flTextMode == undefined) {
					localStorage.flTextMode = "true";
					}
				if (localStorage.flReorgMode == undefined) {
					localStorage.flReorgMode = "false";
					}
				}
			function secondsSince (when) {
				var now = new Date ();
				return ((now - when) / 1000);
				}
			function opExpandCallback (op) {
				var type = op.attributes.getOne ("type"), url = op.attributes.getOne ("url"), xmlUrl = op.attributes.getOne ("xmlUrl");
				//link nodes
					if ((type == "link") && (url != undefined)) {
						window.open (url);
						return;
						}
				//rss nodes -- 3/25/13 by DW
					if ((type == "rss") && (xmlUrl != undefined)) {
						window.open (xmlUrl);
						return;
						}
				//include nodes
					if ((type == "include") && (url != undefined)) {
						op.deleteSubs ();
						op.clearChanged ();
						readText (url, insertIncludedOpml, op, true);
						}
				}
			function opInsertCallback (op) { 
				var atts = {};
				atts.created = new Date ().toUTCString (); //1/18/13 by DW
				op.attributes.addGroup (atts);
				}
			function opCollapseCallback (op) {
				var type = op.attributes.getOne ("type");
				if (type == "include") {
					op.deleteSubs ();
					op.clearChanged ();
					}
				console.log ("Collapse");
				}
			function opHoverCallback (op) { 
				var atts = op.attributes.getAll (), s = "";
				//set cursor to pointer if there's a url attribute -- 3/24/13  by DW
					if ((atts.url != undefined) || (atts.xmlUrl != undefined)) {
						document.body.style.cursor = "pointer";
						}
					else {
						document.body.style.cursor = "default";
						}
				
				}
			function opCursorMovedCallback (op) {
				}
			function opKeystrokeCallback (event) { 
				var now = new Date ();
				whenLastKeystroke = now; 
				if ((event.which == 191) && event.metaKey && event.shiftKey) { //cmd-? -- 3/27/13 by DW
					showCribsheet ();
					}
				}
			function runSelection () {
				var value = eval (opGetLineText ());
				opDeleteSubs ();
				opInsert (value, "right");
				opGo ("left", 1);
				}
			function setOutlinerPrefs (id, flRenderMode, flReadonly) {
				$(id).concord ({
					"prefs": {
						"outlineFont": appPrefs.outlineFont, 
						"outlineFontSize": appPrefs.outlineFontSize, 
						"outlineLineHeight": appPrefs.outlineLineHeight,
						"renderMode": flRenderMode,
						"readonly": flReadonly,
						"typeIcons": appTypeIcons
						},
					"callbacks": {
						"opInsert": opInsertCallback,
						"opCursorMoved": opCursorMovedCallback,
						"opExpand": opExpandCallback,
						"opHover": opHoverCallback, 
						"opKeystroke": opKeystrokeCallback
						}
					});
				}
			function saveOutlineNow () {
				localStorage.savedOpmltext = opOutlineToXml (appPrefs.authorName, appPrefs.authorEmail);
				localStorage.ctOpmlSaves++;
				opClearChanged ();
				console.log ("saveOutlineNow: saved outline. " + localStorage.savedOpmltext.length + " chars.");
				}
			function backgroundProcess () {
				if (opHasChanged ()) {
					if (secondsSince (whenLastKeystroke) >= 1) { 
						saveOutlineNow ();
						}
					}
				}
			function startup () {
				initLocalStorage ();
				setOutlinerPrefs ("#outliner", false, false);
				opSetFont (appPrefs.outlineFont, appPrefs.outlineFontSize, appPrefs.outlineLineHeight); 
				opXmlToOutline (localStorage.savedOpmltext);
				
				$("#idProductName").text (appConsts.productnameForDisplay);
				$("#idVersionNumber").text ("v" + appConsts.version);
				
				self.setInterval (function () {backgroundProcess ()}, 1000); //call every second
				}
			</script>
		<style>
			body {
				background-color: whitesmoke;
				}
			.divOutlinerContainer { 
				width: 75%;
				margin-top: 90px;
				margin-left: auto;
				margin-right: auto;
				border:1px solid gainsboro;
				min-height: 550px;
				max-height: 800px;
				padding: 6px;
				overflow: auto;
				background-color: white;
				}
			.btn {
				width: 80px;
				}
			/* icon chain */
				.divIconChain {
					float: right;
					padding: 3px;
					margin-right: 5px;
					}
				.divIcon i {
					font-size: 20px;
					font-weight: bold;
					color: gray; //silver;
					padding-bottom: 35px;
					}
			/* four arrows */
				.divFourArrows {
					padding-left: 10px;
					padding-right: 10px;
					}
				.divFourArrows i {
					font-size: 36px;
					color: gray; //silver;
					cursor: pointer;
					}
				.divFourArrows a:hover {
					text-decoration: none;
					}
			.divArrowPad {
				right: 4%;
				top: 5%;
				z-index: 1002;
				color: #fff;
				position: fixed;
				text-align: center;
				font-family: arial,sans-serif;
				font-size: 16px;
				line-height: 130%;
				background: #222 none repeat scroll 0;
				overflow: hidden;
				opacity: .85;
				padding: 5px;
				}
			.divCloseIcon {
				margin-top: -5px;
				float: left;
				cursor: pointer;
				color: gainsboro;
				font-size: .8em;
				}
			</style>
		</head>
	<body>
		<p><span id="idProductName"></span>&nbsp;<span id="idVersionNumber"></span></p>
		
		<div class="divOutlinerContainer">
			<div id="outliner">
				</div>
			</div>
		<script>
			$(document).ready (function () {
				startup ();
				});
			</script>
		</body>
	</html>
