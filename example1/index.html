<html>
	<head>
		<title>Hello outliner</title>
		<meta name="copyright" content="Copyright 2013, Small Picture, Inc.">
		<script src="http://rawgithub.com/scripting/concord/master/libraries/jquery-1.9.1.min.js"></script>
		<link href="http://rawgithub.com/scripting/concord/master/libraries/bootstrap.css" rel="stylesheet">
		<script src="http://rawgithub.com/scripting/concord/master/libraries/bootstrap.min.js"></script>
		<link rel="stylesheet" href="http://rawgithub.com/scripting/concord/master/concord.css"/>
		<script src="http://rawgithub.com/scripting/concord/master/concord.js"></script>
		<script src="http://rawgithub.com/scripting/concord/master/concordUtils.js"></script>
		<link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
		
		<script>
			var appConsts = {
				"productname": "Hello",
				"productnameForDisplay": "Hello Outliner",
				"domain": "hello.blorkmark.com", 
				"version": "0.42"
				}
			var appPrefs = {
				"outlineFont": "Georgia", "outlineFontSize": 18, "outlineLineHeight": 27,
				"authorName": "", "authorEmail": ""
				};
			var whenLastKeystroke = new Date (), whenLastAutoSave = new Date ();  
			var flReadOnly = false, flRenderMode = false;
			var cmdKeyPrefix = "Ctrl+"; 
			var urlHelloOutliner = "http://static.smallpicture.com/tacoma/wo/admin/2013/09/12/archive049.opml";
			
			
			
			function setInclude () {
				opSetOneAtt ("type", "include");
				opSetOneAtt ("url", "http://smallpicture.com/states.opml");
				}
			function editSource (url) {
				readText (url, function (opmltext, op) {
					opXmlToOutline (opmltext);
					}, undefined, true);
				}
			
			function secondsSince (when) {
				var now = new Date ();
				return ((now - when) / 1000);
				}
			function initLocalStorage () {
				if (localStorage.savedOpmltext == undefined) {
					localStorage.savedOpmltext = initialOpmltext;
					}
				if (localStorage.ctOpmlSaves == undefined) {
					localStorage.ctOpmlSaves = 0;
					}
				if (localStorage.whenLastSave == undefined) {
					localStorage.whenLastSave = new Date ().toString ();
					}
				if (localStorage.flTextMode == undefined) {
					localStorage.flTextMode = "true";
					}
				}
			function opExpandCallback (op) {
				var type = op.attributes.getOne ("type"), url = op.attributes.getOne ("url"), xmlUrl = op.attributes.getOne ("xmlUrl");
				//link nodes
					if ((type == "link") && (url != undefined)) {
						window.open (url);
						return;
						}
				//rss nodes
					if ((type == "rss") && (xmlUrl != undefined)) {
						window.open (xmlUrl);
						return;
						}
				//include nodes
					if ((type == "include") && (url != undefined)) {
						op.deleteSubs ();
						op.clearChanged ();
						readText (url, function (opmltext, op) {
							op.insertXml (opmltext, right); 
							op.clearChanged ();
							}, op, true);
						}
				}
			function opInsertCallback (op) { 
				var atts = {};
				atts.created = new Date ().toUTCString (); //1/18/13 by DW
				op.attributes.addGroup (atts);
				}
			function opCollapseCallback (op) {
				var type = op.attributes.getOne ("type");
				if (type == "include") {
					op.deleteSubs ();
					op.clearChanged ();
					}
				console.log ("Collapse");
				}
			function opHoverCallback (op) { 
				var atts = op.attributes.getAll (), s = "";
				//set cursor to pointer if there's a url attribute -- 3/24/13  by DW
					if ((atts.url != undefined) || (atts.xmlUrl != undefined)) {
						document.body.style.cursor = "pointer";
						}
					else {
						document.body.style.cursor = "default";
						}
				
				}
			function opCursorMovedCallback (op) {
				}
			function opKeystrokeCallback (event) { 
				var now = new Date ();
				whenLastKeystroke = now; 
				if ((event.which == 191) && event.metaKey && event.shiftKey) { //cmd-? -- 3/27/13 by DW
					showCribsheet ();
					}
				}
			function runSelection () {
				var value = eval (opGetLineText ());
				opDeleteSubs ();
				opInsert (value, "right");
				opGo ("left", 1);
				}
			function setOutlinerPrefs (id, flRenderMode, flReadonly) {
				$(id).concord ({
					"prefs": {
						"outlineFont": appPrefs.outlineFont, 
						"outlineFontSize": appPrefs.outlineFontSize, 
						"outlineLineHeight": appPrefs.outlineLineHeight,
						"renderMode": flRenderMode,
						"readonly": flReadonly,
						"typeIcons": appTypeIcons
						},
					"callbacks": {
						"opInsert": opInsertCallback,
						"opCursorMoved": opCursorMovedCallback,
						"opExpand": opExpandCallback,
						"opHover": opHoverCallback, 
						"opKeystroke": opKeystrokeCallback
						}
					});
				}
			function saveOutlineNow () {
				localStorage.savedOpmltext = opOutlineToXml (appPrefs.authorName, appPrefs.authorEmail);
				localStorage.ctOpmlSaves++;
				opClearChanged ();
				console.log ("saveOutlineNow: saved outline. " + localStorage.savedOpmltext.length + " chars.");
				}
			function backgroundProcess () {
				if (opHasChanged ()) {
					if (secondsSince (whenLastKeystroke) >= 1) { 
						saveOutlineNow ();
						}
					}
				}
			function startup () {
				initLocalStorage ();
				//init menu keystrokes
					if (navigator.platform.toLowerCase ().substr (0, 3) == "mac") {
						cmdKeyPrefix = "&#8984;";
						}
					$("#idMenubar .dropdown-menu li").each (function () {
						var li = $(this);
						var liContent = li.html ();
						liContent = liContent.replace ("Cmd-", cmdKeyPrefix);
						li.html (liContent);
						});
				setOutlinerPrefs ("#outliner", false, false);
				opSetFont (appPrefs.outlineFont, appPrefs.outlineFontSize, appPrefs.outlineLineHeight); 
				opXmlToOutline (localStorage.savedOpmltext);
				
				$("#idMenuProductName").text (appConsts.productname);
				$("#idProductVersion").text ("v" + appConsts.version);
				
				self.setInterval (function () {backgroundProcess ()}, 1000); //call every second
				}
			</script>
		<style>
			body {
				background-color: whitesmoke;
				}
			.divOutlinerContainer { 
				width: 65%;
				margin-top: 75px;
				margin-left: auto;
				margin-right: auto;
				border:1px solid gainsboro;
				min-height: 550px;
				max-height: 800px;
				overflow: auto;
				padding: 6px;
				background-color: white;
				}
			.divSubtext {
				width: 65%;
				margin-top: 3px;
				margin-left: auto;
				margin-right: auto;
				}
			/* menubar */
				.divMenubar .container { 
					margin-left: auto;
					margin-right: auto;
					width: 940px;
					}
				.divMenubar .navbar .nav > li > a { 
					font-size: 15px;
					padding-top: 12px;
					padding-left: 8px; padding-right: 8px; //6/3/13 by DW
					outline: none !important;
					}
				.dropdown-menu > li > a {
					cursor: pointer;
					}
				.navbar-inner { 
					-moz-border-radius: 0;
					-moz-border-radius: none; 
					-moz-box-shadow: none; 
					background-image: none; 
					border-radius: 0;  
					}
				.divMenubar .brand { 
					margin-top: 0;
					}
				.divMenubar .nav li {
					font-family: Arial;
					font-size: 14px;
					font-weight: bold;
					}
				.menuKeystroke {
					float: right;
					margin-left: 25px;
					}
				.menuKeystroke:before {
					content: "";
					}
				 #idMenuProductName {
					font-family: "Arial";
					font-size: 24px;
					font-weight: bold;
					font-style: italic;
					}
			</style>
		</head>
	<body>
		<div class="divForkMe">
			<a href="https://github.com/scripting/concord"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>
			</div>
		<div class="divMenubar" id="idMenubar">
			<div class="topbar-wrapper" style="z-index: 5;">
				<div class="navbar navbar-fixed-top" data-dropdown="dropdown">
					<div class="navbar-inner">
						<div class="container">
							<a class="brand" href="/"><span id="idMenuProductName"></span></a>
							<ul class="nav" id="idMainMenuList">
								<li class="dropdown" id="idOutlinerMenu"> 
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">Outliner&nbsp;<b class="caret"></b></a>
									<ul class="dropdown-menu">
										<li><a onclick="opExpand ();"><span class="menuKeystroke">Cmd-,</span>Expand</a></li>
										<li><a onclick="opExpandAllLevels ();">Expand All Subs</a></li>
										<li><a onclick="opExpandEverything ();">Expand Everything</a></li>
										
										<li class="divider"></li>
										<li><a onclick="opCollapse ();"><span class="menuKeystroke">Cmd-.</span>Collapse</a></li>
										<li><a onclick="opCollapseEverything ();">Collapse Everything</a></li>
										
										<li class="divider"></li>
										<li><a onclick="opReorg (up, 1);"><span class="menuKeystroke">Cmd-U</span>Move Up</a></li>
										<li><a onclick="opReorg (down, 1);"><span class="menuKeystroke">Cmd-D</span>Move Down</a></li>
										<li><a onclick="opReorg (left, 1);"><span class="menuKeystroke">Cmd-L</span>Move Left</a></li>
										<li><a onclick="opReorg (right, 1);"><span class="menuKeystroke">Cmd-R</span>Move Right</a></li>
										
										<li class="divider"></li>
										<li><a onclick="opPromote ();"><span class="menuKeystroke">Cmd-[</span>Promote</a></li>
										<li><a onclick="opDemote ();"><span class="menuKeystroke">Cmd-]</span>Demote</a></li>
										
										<li class="divider"></li>
										<li><a onclick="runSelection ();"><span class="menuKeystroke">Cmd-/</span>Run Selection</a></li>
										<li><a onclick="toggleComment ();"><span class="menuKeystroke">Cmd-\</span>Toggle Comment</a></li>
										
										<li class="divider"></li>
										<li><a onclick="toggleRenderMode ();"><span class="menuKeystroke">Cmd-`</span>Toggle Render Mode</a></li>
										</ul>
									</li>
								<li class="dropdown" id="idSourceMenu"> 
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">Source&nbsp;<b class="caret"></b></a>
									<ul class="dropdown-menu">
										<li><a onclick="editSource (urlHelloOutliner);">Hello Outliner</a></li>
										</ul>
									</li>
								</ul>
							<ul class="nav pull-right">
								<li>
									<a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="idProductVersion"></span></a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		<div class="divOutlinerContainer">
			<div id="outliner">
				</div>
			</div>
		<div class="divSubtext">
			<p>This is the outliner at the core of <a href="http://fargo.io/">Fargo</a>. All the outline operations work. The outline is saved as you work in HTML 5 localStorage. The full source and docs are on <a href="https://github.com/scripting/concord">GitHub</a>.</p>
			</div>
		<script>
			$(document).ready (function () {
				startup ();
				});
			</script>
		</body>
	</html>
